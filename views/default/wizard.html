{{extend 'layout.html'}}

<script type="text/javascript">profilepackages=''</script>
<script type="text/javascript">defaultpackages='{{for pkg in defaultpkgs:}}{{=pkg}} {{pass}}'</script>
<script type="text/javascript">extrapackages=''</script>
<script type="text/javascript">communitypackages = '{{=community_packages}}'</script>
<script type="text/javascript">nosharepackages = ''</script>
<script type="text/javascript">lucipackages = ''</script>
<script type="text/javascript">ipv6packages = '{{=ipv6_packages}}'</script>
<script type="text/javascript">user_packagelist = '{{=user_packagelist}}'</script>
<script type="text/javascript">addpackages = '{{=addpackages}}'</script>

{{if session.expert:}}
<style type="text/css">
.expert{
	display: inline !important;
}
#tab-lan, #tab-wan, #tab-packages, #tab-upload {
	display: block !important;
}
</style>
{{pass}}

<script>
$(function() {
$( "#accordion" ).accordion({ heightStyle: "content" });
});
</script>

<h1>{{=T('2. Image configuration')}}</h1>

<form action="" name="MAINFORM" enctype="multipart/form-data" method="POST">
  <div id="accordion">
  <!-- Start system tab -->
    <h3 title="{{=T('Basic system settings')}}">{{=T('System')}}</h3>
    <div>
      <div class="tab-description">
        {{=T('Basic system settings.')}}
      </div>
      {{if session.profiles:}}
        {{
        field_profile = formhelpers.formfield()
        field_profile.Name = 'profile'
        field_profile.Label = T('Profile')
        field_profile.Valuelist = session.profiles
        field_profile.Valueselected = session.profile
        field_profile.Helptext = T('This sets a profile for your router model. If your device is not listed try something generic (default) if available.')
        field_profile.Special = 'onchange="var e = document.getElementById(\'imageconf_profile\'); var selected = e.options[e.selectedIndex].value; ProfilePkgs(\'' + URL('static', 'ajax/' + session.target) + '\', selected);"'
        field_profile = field_profile.select()
        }}
        {{=field_profile}}
      {{pass}}

      <script type="text/javascript">
        var e = document.getElementById('imageconf_profile');
        var selected = e.options[e.selectedIndex].value;
        ProfilePkgs('{{=URL("static", "ajax/" + session.target)}}', selected);
        update_defaultpkgs();
      </script>
      
        {{if session.community == 'weimar':}}
        {{
        field_nodenumber = formhelpers.formfield()
        field_nodenumber.Name = 'nodenumber'
        field_nodenumber.Label = T('Node Number')
        field_nodenumber.Helptext = T('Please enter the Node Number for your weimarnetz node.')
        field_nodenumber.Value = request.vars.nodenumber or ''
        field_nodenumber.Special = 'onchange="FFReg.check(this.value, _ffreg_check_callback)"'
        field_nodenumber = field_nodenumber.input()
        }}
        {{=field_nodenumber}}
	{{pass}}

      <div class="expert">
        {{
        field_webif = formhelpers.formfield()
        field_webif.Name = 'webif'
        field_webif.Label = T('Webinterface')
        field_webif.Valuelist = config.webifs
        field_webif.Valueselected = form.vars.webif
        field_webif.Helptext = T('Webinterface that is installed. This may remove or add packages depending on your selection.')
        field_webif.Special = 'onchange="themeselect()"'
        field_webif = field_webif.select()
        }}
        {{=field_webif}}
      </div>

      {{
        field_theme = formhelpers.formfield()
        field_theme.Name = 'theme'
        field_theme.Label = T('Theme')
        field_theme.Valuelist = themes
        field_theme.Valueselected = session.theme
        field_theme.Helptext = T('Webinterface that will be installed.')
        field_theme.Special = 'onchange="themepkgs()"'
        field_theme = field_theme.select()
      }}

      <div id="theme_options" class="expert">
        <!-- this will be replaced by the js below -->
      </div>



      {{if not session.noconf == True:}}
        {{
        field_hostname = formhelpers.formfield()
        field_hostname.Name = 'hostname'
        field_hostname.Label = T('Hostname')
        field_hostname.Helptext = T('Hostname. If left empty it will be autogenerated from the IPv4 address')
        field_hostname.Value = request.vars.hostname or ''
        field_hostname = field_hostname.input()
        }}
        {{=field_hostname}}


        {{if session.ipv6conf == True:}}
        <div class="expert">
          {{
          field_ipv6 = formhelpers.formfield()
          field_ipv6.Name = 'ipv6'
          field_ipv6.Label = T('IPv6')
          field_ipv6.Helptext = T('Enable/Disable IPv6 globally.')
          field_ipv6.Value = session.ipv6
          field_ipv6.Special = 'onchange="ipv6pkgs();"'
          field_ipv6 = field_ipv6.chkbox()
          }}
          {{=field_ipv6}}
        </div>
        {{pass}}


        <div class="expert">
          {{
          field_pubkeys = formhelpers.formfield()
          field_pubkeys.Name = 'pubkeys'
          field_pubkeys.Label = T('Public Keys')
          field_pubkeys.Helptext = T('Add ssh public keys, one per line.')
          field_pubkeys.Special = 'wrap="off"'
          field_pubkeys.Value = form.vars.pubkeys or session.pubkeys
          field_pubkeys = field_pubkeys.textarea()
          }}
          {{=field_pubkeys}}
        </div>
      {{pass}}
    </div>

    <!-- Start location tab -->
    {{if not session.noconf == True and session.communitysupport == True:}}
    <h3 title="{{=T('Location for this node')}}">{{=T('Location')}}</h3>
    <div>
      <div class="tab-description">
        {{=T('Enter the coordinates and location for your node here. This is used to show your node on maps of the mesh network.')}}
      </div>
      <span id='osm'>
        {{
        field_latitude = formhelpers.formfield()
        field_latitude.Name = 'latitude'
        field_latitude.Label = T('Latitude')
        field_latitude.Helptext = T('Latitude') + " " + T('in decimal notation.')
        field_latitude.Value = request.vars.latitude or lat or ''
        if form.errors.latitude:
            field_latitude.Errormsg = T('Latitude') + ' ' + T('must be a decimal value between -180 and 180, e.g. 12.34567.')
        pass
        field_latitude = field_latitude.input()

        field_longitude = formhelpers.formfield()
        field_longitude.Name = 'longitude'
        field_longitude.Label = T('Longitude')
        field_longitude.Helptext = T('Longitude') + " " + T('in decimal notation.')
        field_longitude.Value = lon or ''
        if form.errors.longitude:
            field_longitude.Errormsg = T('Longitude') + ' ' + T('must be a decimal value between -180 and 180, e.g. 12.34567.')
        pass
        field_longitude = field_longitude.input()

        field_location = formhelpers.formfield()
        field_location.Name = 'location'
        field_location.Label = T('Location')
        field_location.Helptext = T('Location of your node.')
        field_location.Value = form.vars.location or session.location
        field_location.Errormsg = form.errors.location
        field_location = field_location.input()
        }}
        {{=field_location}}
        {{=field_latitude}}
        {{=field_longitude}}
        <input type="button" id="showmap" value="{{=T('Show map')}}" style="cursor:pointer" onclick="toggle_button()">
      </span>

	  <script type='text/javascript'>
		function toggle_container(cmd) {
		  if ( cmd == 'show' ) {
			var osm1 = function() {
			  loadScript('http://www.openstreetmap.org/openlayers/OpenStreetMap.js', osm2);
			};
			document.getElementById('map_container').innerHTML="<div id='map'></div><div style='font-size:0.8em'>Map by <a href='http://www.openstreetmap.org' title='www.openstreetmap.org'>openstreetmap.org</a>, License CC-BY-SA</div>";
			loadScript('http://www.openlayers.org/api/OpenLayers.js', osm1);
			var osm2 = function() {
			  loadScript('{{=URL("static", "js/osm.js")}}',do_map);
			};
			var do_map = function() {
			  init(); drawmap();
			};

			} else {
			  document.getElementById('map_container').innerHTML = '';
			}
		  }

		  function toggle_button() {
			var val = document.getElementById('showmap').value;
			if (val == '{{=T('Show map')}}' ) {
			  var val = document.getElementById('showmap').value = '{{=T("Hide map")}}';
			  toggle_container('show');
			}
			else
			{
			  var val = document.getElementById('showmap').value = '{{=T("Show map")}}';
			  toggle_container('hide');
			}
		  }
	</script>

	  <div id='map_container'></div>
    </div>
  {{pass}}
  <!-- End location tab -->

  {{if not session.noconf == True and session.communitysupport == True:}}
  <!-- Start contact tab -->
  <h3 title="{{=T('Contact')}}">{{=T('Contact')}}</h3>
  <div>
      <div class="tab-description">
        {{=T('Please enter some personal informations here so others can contact you. Please have at least one valid contact option (email or phone).')}}
      </div>
    {{
      field_nickname = formhelpers.formfield()
      field_nickname.Name = 'nickname'
      field_nickname.Label = T('Nickname')
      field_nickname.Helptext = T('Enter your nickname here.')
      field_nickname.Value = form.vars.nickname or session.nickname or ''
      field_nickname.Errormsg = form.errors.nickname
      field_nickname = field_nickname.input()
      field_name = formhelpers.formfield()
      field_name.Name = 'name'
      field_name.Label = T('Name')
      field_name.Helptext = T('Enter your name here.')
      field_name.Value = form.vars.name or session.name or ''
      field_name.Errormsg = form.errors.name
      field_name = field_name.input()
      field_email = formhelpers.formfield()
      field_email.Name = 'email'
      field_email.Label = T('Mail')
      field_email.Helptext = T('Enter your email address here.')
      field_email.Value = form.vars.email or session.mail or ''
      field_email.Errormsg = form.errors.email
      field_email = field_email.input()
      field_phone = formhelpers.formfield()
      field_phone.Name = 'phone'
      field_phone.Label = T('Phone')
      field_phone.Helptext = T('Enter your phone number here.')
      field_phone.Value = form.vars.phone or session.phone or ''
      field_phone.Errormsg = form.errors.phone
      field_phone = field_phone.input()
      field_note = formhelpers.formfield()
      field_note.Name = 'note'
      field_note.Label = T('Note')
      field_note.Helptext = T('You may enter a cusom comment here.')
      field_note.Value = form.vars.note or session.note or ''
      field_note.Errormsg = form.errors.note
      field_note = field_note.textarea()
    }}
    {{=field_nickname}}
    {{=field_name}}
    {{=field_email}}
    {{=field_phone}}
    {{=field_note}}
  </div>
  <!-- End contact tab -->
  {{pass}}

  {{if session.community <> 'weimar' and not session.noconf == True:}}
  <!-- Start wifi tab -->
  <h3 title="{{=T('Wireless')}}">{{=T('Wireless')}}</h3>
  <div>
      <div class="tab-description">
        {{=T('Configure your wireless interface(s) here. These will be configured to operate in adhoc mode with the correct settings for your community.')}}
      </div>

	  <input type="hidden" name="wifiifsnr" id="wifiifsnr" value="{{=form.vars.wifiifsnr or 1}}" />
	  <script type="text/javascript">
		var wifi_counter = 0;
		var wifi_limit = 3;
		function removeWifi(number) {
		  if (document.getElementById(number)) {
			parent = document.getElementById(number).parentNode
			child = document.getElementById(number);
			parent.removeChild(child);
			wifi_counter--;
			document.getElementById("wifiifsnr").value = wifi_counter;
		  };
		}
		function addInput(divName){
		  if (wifi_counter == wifi_limit)  {
			alert("{{=T('Maximum number of wifi interfaces reached.')}}");
		  }
		  else {
			var e_wifi0_ipv4addr = "{{=form.errors.wifi0ipv4addr}}";
			var e_wifi1_ipv4addr = "{{=form.errors.wifi1ipv4addr}}";
			var e_wifi2_ipv4addr = "{{=form.errors.wifi2ipv4addr}}";
			var v_wifi0_ipv4addr = "{{=form.vars.wifi0ipv4addr or defip}}";
			var v_wifi1_ipv4addr = "{{=form.vars.wifi1ipv4addr or defip}}";
			var v_wifi2_ipv4addr = "{{=form.vars.wifi2ipv4addr or defip}}";

			var e_wifi0_ipv6addr = "{{=form.errors.wifi0ipv6addr}}";
			var e_wifi1_ipv6addr = "{{=form.errors.wifi1ipv6addr}}";
			var e_wifi2_ipv6addr = "{{=form.errors.wifi2ipv6addr}}";
			var v_wifi0_ipv6addr = "{{=form.vars.wifi0ipv6addr or ''}}";
			var v_wifi1_ipv6addr = "{{=form.vars.wifi1ipv6addr or ''}}";
			var v_wifi2_ipv6addr = "{{=form.vars.wifi2ipv6addr or ''}}";

			var e_wifi0_chan = "{{=form.errors.wifi0chan}}";
			var e_wifi1_chan = "{{=form.errors.wifi1chan}}";
			var e_wifi2_chan = "{{=form.errors.wifi2chan}}";
			var v_wifi0_chan = "{{=form.vars.wifi0chan or defchannel}}";
			var v_wifi1_chan = "{{=form.vars.wifi1chan or defchannel}}";
			var v_wifi2_chan = "{{=form.vars.wifi2chan or defchannel}}";

			var e_wifi0_dhcprange = "{{=form.errors.wifi0dhcprange}}";
			var e_wifi1_dhcprange = "{{=form.errors.wifi1dhcprange}}";
			var e_wifi2_dhcprange = "{{=form.errors.wifi2dhcprange}}";
			var v_wifi0_dhcprange = "{{=form.vars.wifi0dhcprange or ''}}";
			var v_wifi1_dhcprange = "{{=form.vars.wifi1dhcprange or ''}}";
			var v_wifi2_dhcprange = "{{=form.vars.wifi2dhcprange or ''}}";

			var v_wifi0_vap = "{{=form.vars.wifi0vap or session.wifi0vap or ''}}";
			var v_wifi1_vap = "{{=form.vars.wifi1vap or session.wifi1vap or ''}}";
			var v_wifi2_vap = "{{=form.vars.wifi2vap or session.wifi2vap or ''}}";

			var v_wifi0_ipv6ra = "{{=form.vars.wifi0ipv6ra or session.wifi0ipv6ra or ''}}";
			var v_wifi1_ipv6ra = "{{=form.vars.wifi1ipv6ra or session.wifi1ipv6ra or ''}}";
			var v_wifi2_ipv6ra = "{{=form.vars.wifi2ipv6ra or session.wifi2ipv6ra or ''}}";

			var newdiv = document.createElement('div');
			wrapper_start = "<div id='wifi" + wifi_counter + "'>";
			wrapper_start += "<fieldset class='section' xmlns='http://www.w3.org/1999/xhtml'>";
			wrapper_start += "<legend>Wifi" + wifi_counter;
			wrapper_start += "<span class='sectionremove'>";
			wrapper_start += "<a onclick=\"removeWifi('wifi" + wifi_counter + "')\" ";
			wrapper_start += "href='javascript:void(0)' title='{{=T('Remove')}}'>";
			wrapper_start += "<img src=\"{{=URL('static', 'images/icons/remove.gif')}}\" alt=\"{{=T('Remove')}}\">";
			wrapper_start += "</a></span></legend>";

			wifi_ipv4addr_label = "<label id='imageconf_wifi" + wifi_counter + "ipv4addr__label' ";
			wifi_ipv4addr_label += "for='imageconf_wifi" + wifi_counter + "ipv4addr' class='form_label'>";
			wifi_ipv4addr_label += "{{=T('IPv4 address')}}</label>";
			wifi_ipv4addr_input = "<div class='form_value'>";
			wifi_ipv4addr_input += "<input type='text' id='imageconf_wifi" + wifi_counter + "ipv4addr' ";
			wifi_ipv4addr_input += "value='" + eval('v_wifi' + wifi_counter + '_ipv4addr') + "' name='wifi" + wifi_counter + "ipv4addr'/>";
			wifi_ipv4addr_input += '{{=formhelpers.helptext(T("IPv4 address for this interface."),config.expandablehelp)}}';

			for (var i=0; i<wifi_limit; i++) {
			  var e = eval("e_wifi" + i + "_ipv4addr");
			  if (e!="None" && wifi_counter==i)  {
				wifi_ipv4addr_input += "<div id='wifi" + wifi_counter + "ipv4addr__error' class='error'>" + e + "</div>";
			  }
			}
			wifi_ipv4addr_input += "</div>"
			wifi_ipv4addr = wifi_ipv4addr_label + wifi_ipv4addr_input;

			wifi_ipv6addr = '';
			{{ if session.ipv6_config == 'static':}}
			wifi_ipv6addr_label = "<label id='imageconf_wifi" + wifi_counter + "ipv6addr__label' ";
			wifi_ipv6addr_label += "for='imageconf_wifi" + wifi_counter + "ipv6addr' class='form_label'>";
			wifi_ipv6addr_label += "{{=T('IPv6 address')}}</label>";
			wifi_ipv6addr_input = "<div class='form_value'>";
			wifi_ipv6addr_input += "<input type='text' id='imageconf_wifi" + wifi_counter + "ipv6addr' ";
			wifi_ipv6addr_input += "value='" + eval('v_wifi' + wifi_counter + '_ipv6addr') + "' name='wifi" + wifi_counter + "ipv6addr'/>";
			for (var i=0; i<wifi_limit; i++) {
			  var e = eval("e_wifi" + i + "_ipv6addr");
			  if (e!="None" && wifi_counter==i)  {
				wifi_ipv6addr_input += "<div id='wifi" + wifi_counter + "ipv6addr__error' class='error'>" + e + "</div>";
			  }
			}
			wifi_ipv6addr_input += "</div>"
			wifi_ipv6addr = wifi_ipv6addr_label + wifi_ipv6addr_input;
			{{pass}}

			wifi_ipv6ra = '';
			{{ if session.ipv6_config == 'auto-ipv6-random' or session.ipv6_config == 'auto-ipv6-fromv4' or session.ipv6_config == 'static':}}
			wifi_ipv6ra_label = "<label id='imageconf_wifi" + wifi_counter + "ipv6ra__label' ";
			wifi_ipv6ra_label += "for='imageconf_wifi" + wifi_counter + "ipv6ra' class='expert form_label'>";
			wifi_ipv6ra_label += "{{=T('Router Advertisement')}}</label>";
			wifi_ipv6ra_input = "<div class='form_value expert'>";
			checked = ''
			for (var i=0; i<wifi_limit; i++) {
			  var v = eval("v_wifi" + i + "_ipv6ra");
			  if ((v=="True" || v=="on") && wifi_counter==i)  {
				checked = ' checked="1" ';
			  }
			}
			wifi_ipv6ra_input += "<input type='checkbox'" + checked;
			wifi_ipv6ra_input += "name='wifi" + wifi_counter + "ipv6ra' id='imageconf_wifi" + wifi_counter +"ipv6ra'/>";
			wifi_ipv6ra_input += '{{=formhelpers.helptext(T("Send IPv6 router advertisements."),config.expandablehelp)}}';
			wifi_ipv6ra_input += "</div>"
			wifi_ipv6ra = wifi_ipv6ra_label + wifi_ipv6ra_input;
			{{pass}}

			wifi_chan_label = "<label id='imageconf_wifi" + wifi_counter + "chan__label' ";
			wifi_chan_label += "for='imageconf_wifi" + wifi_counter + "chan' class='form_label'>";
			wifi_chan_label += "{{=T('Channel')}}</label>";
			wifi_chan_input = "<div class='form_value'>";
			wifi_chan_input += "<input type='text' id='imageconf_wifi" + wifi_counter + "chan' ";
			wifi_chan_input += "value='" + eval('v_wifi' + wifi_counter + '_chan') + "' name='wifi" + wifi_counter + "chan'/>";
			for (var i=0; i<wifi_limit; i++) {
			  var e = eval("e_wifi" + i + "_chan");
			  if (e!="None" && wifi_counter==i)  {
				wifi_chan_input += "<div id='wifi" + wifi_counter + "chan__error' class='error'>" + e + "</div>";
			  }
			}
			wifi_chan_input += "</div>";
			wifi_chan = wifi_chan_label + wifi_chan_input;

			wifi_dhcp_label = "<label id='imageconf_wifi" + wifi_counter + "dhcp__label' ";
			wifi_dhcp_label += "for='imageconf_wifi" + wifi_counter + "dhcp' class='form_label'>";
			wifi_dhcp_label += "{{=T('Enable DHCP')}}</label>";
			wifi_dhcp_input = "<div class='form_value'>";
			wifi_dhcp_input += "<input type='checkbox' checked='' ";
			wifi_dhcp_input += "name='wifi" + wifi_counter + "dhcp' id='imageconf_wifi" + wifi_counter +"dhcp'/>";
			wifi_dhcp_input += "<a onclick=\"ToggleDiv('wifi" + wifi_counter + "dhcp_range')\" ";
			wifi_dhcp_input += "title='Advanced Options' class='advanced' href='javascript:void(0)'>+/-</a>"
			wifi_dhcp_input += '{{=formhelpers.helptext(T("Enable DHCP and allow guests to connect to the network without using olsrd."),config.expandablehelp)}}';
			wifi_dhcp_input += "</div>"
			wifi_dhcp = '<div class="expert">' + wifi_dhcp_label + wifi_dhcp_input + '</div>'; 



			/* VAP */
			checked = ''
			for (var i=0; i<wifi_limit; i++) {
			  var v = eval("v_wifi" + i + "_vap");
			  if ((v=="True" || v=="on") && wifi_counter==i)  {
				checked = ' checked="1" ';
			  }
			}
			wifi_vap_label = "<label id='imageconf_wifi" + wifi_counter + "vap__label' ";
			wifi_vap_label += "for='imageconf_wifi" + wifi_counter + "vap' class='form_label'>";
			wifi_vap_label += "{{=T('VAP')}}</label>";
			wifi_vap_input = "<div class='form_value'>";
			wifi_vap_input += "<input type='checkbox'" + checked;
			wifi_vap_input += "name='wifi" + wifi_counter + "vap' id='imageconf_wifi" + wifi_counter +"vap'/>";
			wifi_vap_input += '{{=formhelpers.helptext(T("Configure a VAP as Access Point. Only with drivers that support this. At the moment these are madwifi, ath5k and ath9k."),config.expandablehelp)}}';
			wifi_vap_input += "</div>"
			wifi_vap = '<div class="expert">' + wifi_vap_label + wifi_vap_input + '</div>';


			wifi_dhcp_range_wrap_start = "<div style='display: none;' class='suboptions' id='wifi" + wifi_counter + "dhcp_range'>";
			wifi_dhcp_range_label = "<label id='imageconf_wifi" + wifi_counter + "dhcprange__label' ";
			wifi_dhcp_range_label += "for='imageconf_wifi" + wifi_counter + "dhcprange' class='form_label'>";
			wifi_dhcp_range_label += "{{=T('DHCP Range')}}</label>";
			wifi_dhcp_range_input = "<div class='form_value'>";
			wifi_dhcp_range_input += "<input type='text' id='imageconf_wifi" + wifi_counter + "dhcprange' ";
			wifi_dhcp_range_input += "value='" + eval('v_wifi' + wifi_counter + '_dhcprange') + "' name='wifi" + wifi_counter + "dhcprange'/>";
			for (var i=0; i<wifi_limit; i++) {
			  var e = eval("e_wifi" + i + "_dhcprange");
			  if (e!="None" && wifi_counter==i)  {
				wifi_dhcp_range_input += "<div id='wifi" + wifi_counter + "dhcprange__error' class='error'>" + e + "</div>";
			  }
			}
			wifi_dhcp_range_input += '{{=formhelpers.helptext(T("The range from which clients are assigned IP adresses. If it is inside your mesh network, then clients are announced as HNA by olsrd. If it is outside, they are natted. If left blank then a range is autocalculated from 6.0.0.0/8."),config.expandablehelp)}}';
			wifi_dhcp_range_input += "</div>";
			wifi_dhcp_range_wrap_end = "</div>";
			wifi_dhcp_range = wifi_dhcp_range_wrap_start + wifi_dhcp_range_label + wifi_dhcp_range_input + wifi_dhcp_range_wrap_end;
			wrapper_end = "</fieldset></div>";
			newdiv.innerHTML = wrapper_start + wifi_ipv4addr + wifi_ipv6addr + wifi_chan + wifi_dhcp + wifi_vap + wifi_dhcp_range + wifi_ipv6ra + wrapper_end;
			document.getElementById(divName).appendChild(newdiv);
			wifi_counter++;
			document.getElementById("wifiifsnr").value = wifi_counter;
		  }
		}
	  </script>

	  <div id="dynamicWifi">
		<!-- This will be replaced by dynamically created wifi interface config sections -->
	  </div>

	  <!-- add wifi entry(s) -->
	  <script type="text/javascript">
		nr = document.getElementById("wifiifsnr").value;
		var i = 0;
		while (i < nr) {
		  addInput('dynamicWifi');
		  i++;
		}
	  </script>

	  <a href="javascript:void(0)" title="{{=T('Add')}}" onClick="addInput('dynamicWifi');"><img src='{{=URL('static', 'images/icons/add.gif')}}'> {{=T('Add another wifi interface')}}</a>
  </div>
  <!-- End wifi tab -->
  {{pass}}
      
  {{if session.community <> 'weimar' and not session.noconf == True:}}
  <!-- Start Lan tab -->
  <h3 id="tab-lan" title="{{=T('LAN settings')}}">{{=T('LAN')}}</h3>
  <div>
      <div class="tab-description">
        {{=T('You can change the settings for the LAN interface here.')}}</p>
        <ul>
          <li>{{=T('Per default OpenWrt uses the "static" protocol and an ip address of "192.168.1.1" with netmask "255.255.255.0".')}}</li>
          <li>{{=T('If you choose protocol "olsr" then use an ip address from the mesh network. In this case olsr will be enabled on this interface and it will be added to the firewall zone "freifunk".')}}</li>
        </ul>
      </div>
    {{
      field_lanproto = formhelpers.formfield()
      field_lanproto.Name = 'lanproto'
      field_lanproto.Label = T('LAN Protocol')
      field_lanproto.Valuelist = config.lanprotos
      field_lanproto.Valueselected = form.vars.lanproto
      field_lanproto.Helptext = T('Protocol to use for the LAN interface.')
      field_lanproto.Special = 'onchange="lanselect()"'
      field_lanproto = field_lanproto.select()
      field_lanipv4addr = formhelpers.formfield()
      field_lanipv4addr.Name = 'lanipv4addr'
      field_lanipv4addr.Label = T('IPv4 Address')
      field_lanipv4addr.Helptext = T('IPv4 address for the LAN interface')
      field_lanipv4addr.Value = form.vars.lanipv4addr or '192.168.1.1'
      field_lanipv4addr.Errormsg = form.errors.lanipv4addr
      field_lanipv4addr = field_lanipv4addr.input()
      field_lannetmask = formhelpers.formfield()
      field_lannetmask.Name = 'lannetmask'
      field_lannetmask.Label = T('Netmask')
      field_lannetmask.Helptext = T('IPv4 netmask for the LAN interface')
      field_lannetmask.Value = form.vars.lannetmask or '255.255.255.0'
      field_lannetmask.Errormsg = form.errors.lannetmask
      field_lannetmask = field_lannetmask.input()
    }}
    {{=field_lanproto}}
    {{=field_lanipv4addr}}
    {{=field_lannetmask}}

    <div id="lan_options">
      <!--This will be replaced by the javascript below -->
    </div>

    <script type="text/javascript">
      function lanselect() {
        var e = document.getElementById("imageconf_lanproto");
        var selected = e.options[e.selectedIndex].value;
        if ( selected == "static" ) {
          document.getElementById("lan_options").innerHTML = '';
        };
        if ( selected == "olsr" ) {
          lan_ipv6addr = ''
          {{ if session.ipv6_config == 'static':}}
          {{
            field_lanipv6addr = formhelpers.formfield()
            field_lanipv6addr.Name = 'lanipv6addr'
            field_lanipv6addr.Label = T('IPv6 Address')
            field_lanipv6addr.Helptext = T('IPv6 address for the LAN interface')
            field_lanipv6addr.Value = form.vars.lanipv6addr or ''
            field_lanipv6addr.Errormsg = form.errors.lanipv6addr
            field_lanipv6addr = field_lanipv6addr.input()
          }}
          lan_ipv6addr = {{=field_lanipv6addr}};
        {{pass}}

          {{
            field_landhcp = formhelpers.formfield()
            field_landhcp.Name = 'landhcp'
            field_landhcp.Label = T('Enable DHCP')
            field_landhcp.Helptext = T('Enable DHCP-Server for the LAN interface.')
            field_landhcp.Value = form.vars.landhcp or False
            field_landhcp.Errormsg = form.errors.landhcp
            field_landhcp.Advanced = '<a href="javascript:void(0)" class="advanced" title="Advanced Options" onclick=ToggleDiv("lan_dhcp_range")>+/-</a>'
            field_landhcp = field_landhcp.chkbox()
          }}
          landhcp = '{{=field_landhcp}}'

          {{
            field_landhcprange = formhelpers.formfield()
            field_landhcprange.Name = 'landhcprange'
            field_landhcprange.Label = T('DHCP Range')
            field_landhcprange.Helptext = T('The range from which clients are assigned IP adresses. If it is inside your mesh network, then clients are announced as HNA by olsrd. If it is outside, they are natted. If left blank then a range is autocalculated from 6.0.0.0/8.')
            field_landhcprange.Value = form.vars.landhcprange or ''
            field_landhcprange.Errormsg = form.errors.landhcprange
            field_landhcprange = field_landhcprange.input()
          }}

          landhcprangewrapstart = '<div id="lan_dhcp_range" class="suboptions" style="display:none">';
          landhcprangewrapend = '</div>';
          landhcprange = landhcprangewrapstart + '{{=field_landhcprange}}' + landhcprangewrapend;
          lanolsr = lan_ipv6addr + landhcp + landhcprange;
          document.getElementById("lan_options").innerHTML = lanolsr
          hideAll();
        };
      }
      lanselect();
    </script>
  </div>
  <!-- End Lan tab -->
  {{pass}}

  {{if session.community <> 'weimar' and not session.noconf == True:}}
  <!-- Start Wan tab -->
  <h3 id="tab-wan" title="{{=T('WAN settings')}}">{{=T('WAN')}}</h3>
  <div>
    <div class="tab-description">
      {{=T('Configure your wan interface here. The OpenWrt Default is to use "dhcp".')}}
    </div>
    {{
      field_wanproto = formhelpers.formfield()
      field_wanproto.Name = 'wanproto'
      field_wanproto.Label = T('WAN Protocol')
      field_wanproto.Valuelist = config.wanprotos
      field_wanproto.Valueselected = form.vars.wanproto
      field_wanproto.Helptext = T('Protocol to use for the WAN interface.')
      field_wanproto.Special = 'onchange="wanselect()"'
      field_wanproto = field_wanproto.select()

      field_wanipv4addr = formhelpers.formfield()
      field_wanipv4addr.Name = 'wanipv4addr'
      field_wanipv4addr.Label = T('IPv4 Address')
      field_wanipv4addr.Helptext = T('IPv4 address for the wan interface')
      field_wanipv4addr.Value = form.vars.wanipv4addr or ''
      field_wanipv4addr.Errormsg = form.errors.wanipv4addr
      field_wanipv4addr = field_wanipv4addr.input()

      field_wangateway = formhelpers.formfield()
      field_wangateway.Name = 'wangateway'
      field_wangateway.Label = T('Gateway')
      field_wangateway.Helptext = T('Internet gateway')
      field_wangateway.Value = form.vars.wangateway or ''
      field_wangateway.Errormsg = form.errors.wangateway
      field_wangateway = field_wangateway.input()

      field_wandns = formhelpers.formfield()
      field_wandns.Name = 'wandns'
      field_wandns.Label = T('DNS')
      field_wandns.Helptext = T('DNS server(s). Seperate by space if you want to use multiple DNS servers.')
      field_wandns.Value = form.vars.wandns or ''
      field_wandns.Errormsg = form.errors.wandns
      field_wandns = field_wandns.input()

      field_wannetmask = formhelpers.formfield()
      field_wannetmask.Name = 'wannetmask'
      field_wannetmask.Label = T('Netmask')
      field_wannetmask.Helptext = T('IPv4 netmask for the wan interface')
      field_wannetmask.Value = form.vars.wannetmask or ''
      field_wannetmask.Errormsg = form.errors.wannetmask
      field_wannetmask = field_wannetmask.input()

      field_localrestrict = formhelpers.formfield()
      field_localrestrict.Name = 'localrestrict'
      field_localrestrict.Label = T('Protect local network')
      field_localrestrict.Helptext = T('Protect the network behind wan from being accessed from the mesh.')
      field_localrestrict.Value = session.localrestrict or True
      field_localrestrict.Errormsg = form.errors.localrestrict
      field_localrestrict = field_localrestrict.chkbox()

      field_sharenet = formhelpers.formfield()
      field_sharenet.Name = 'sharenet'
      field_sharenet.Label = T('Share internet')
      field_sharenet.Special = 'onchange="nosharepkgs();"'
      field_sharenet.Helptext = T('Allow others in the mesh to use your internet connection. This makes use of the olsrd dyngw_plain plugin, which checks for available internet connectivity and starts to announce it as hna as soon as it is detected.')
      field_sharenet.Value = form.vars.sharenet or False
      field_sharenet.Errormsg = form.errors.sharenet
      field_sharenet = field_sharenet.chkbox()

      field_wan_allow_ssh = formhelpers.formfield()
      field_wan_allow_ssh.Name = 'wan_allow_ssh'
      field_wan_allow_ssh.Label = T('Allow ssh')
      field_wan_allow_ssh.Helptext = T('Add firewall rule to allow ssh access from the wan interface.')
      field_wan_allow_ssh.Value = form.vars.wan_allow_ssh or False
      field_wan_allow_ssh.Errormsg = form.errors.wan_allow_ssh
      field_wan_allow_ssh = field_wan_allow_ssh.chkbox()

      field_wan_allow_web = formhelpers.formfield()
      field_wan_allow_web.Name = 'wan_allow_web'
      field_wan_allow_web.Label = T('Allow web')
      field_wan_allow_web.Helptext = T('Add firewall rule to allow web access from the wan interface.')
      field_wan_allow_web.Value = form.vars.wan_allow_web or False
      field_wan_allow_web.Errormsg = form.errors.wan_allow_web
      field_wan_allow_web = field_wan_allow_web.chkbox()
    }}
    {{=field_wanproto}}	
    <div id="wan_options">
      <!-- This will be replaced by javascript -->
    </div>

    <script type="text/javascript">
      function wanselect() {
        var e = document.getElementById('imageconf_wanproto');
        var selected = e.options[e.selectedIndex].value;

        wanipv4addr = '{{=field_wanipv4addr}}';
        wannetmask = '{{=field_wannetmask}}';
        localrestrict = '{{=field_localrestrict}}';
        sharenet = '{{=field_sharenet}}';
        wan_allow_ssh = '{{=field_wan_allow_ssh}}';
        wan_allow_web = '{{=field_wan_allow_web}}';

        if ( selected == 'dhcp' ) {
          document.getElementById('wan_options').innerHTML = wan_allow_ssh + wan_allow_web + localrestrict + sharenet;
        };
        if ( selected == 'static' ) {
          wangateway = '{{=field_wangateway}}';
          wandns = '{{=field_wandns}}';
          document.getElementById('wan_options').innerHTML = wanipv4addr + wannetmask + wangateway + wandns + localrestrict + sharenet + wan_allow_ssh + wan_allow_web;
        };
        if ( selected == 'olsr' ) {
          document.getElementById('wan_options').innerHTML = wanipv4addr + wannetmask;
        };
        hideAll();
      };
      wanselect();

      function nosharepkgs() {
        if(document.getElementById("imageconf_sharenet").checked) {
          nosharepackages='';
          update_defaultpkgs();
        }
        else {
          nosharepackages = 'freifunk-policyrouting';
          update_defaultpkgs();
        }
      };
      nosharepkgs();
    </script>
  </div>
  <!-- End Wan tab -->
  {{pass}}



  <!-- Start packages tab -->
  <h3 id="tab-packages" title="{{=T('Packages')}}">{{=T('Packages')}}</h3>
  <div>
    <div class="tab-description">
      {{=T('Add or remove packages which are going to be installed into your firmware image here.')}}
    </div>

    <strong>{{=T('Default Packages')}}:</strong> 
    <span id='default_packages'></span>
    <script type='text/javascript'>update_defaultpkgs();</script>
    <div style="clear:both"></div>

    {{
      field_packages = formhelpers.formfield()
      field_packages.Name = 'packages'
      field_packages.Label = T('Packages')
      field_packages = field_packages.textarea()
    }}
    {{=field_packages}}

    <H2>{{=T('Available Packages')}}</h2>

    <div id="packagelist">
      <img src="{{=URL('static', 'images/loading.gif')}}" alt="loading..." title="loading" style="padding-right: 8px">
      Loading package list...
    </div>

    <script type="text/javascript">
      function ajax_packagelist() {
        $.ajax({
          url : '{{=URL('static/package_lists', session.target)}}',
          type : 'get',
          dataType : 'json',
          timeout : 10000,
          tryCount : 0,
          retryLimit : 10,
          success : function(json) {
            var packagelist = "";
              for(var section in json) {
                packagelist += "<h3>" + section + "</h3>";
                packagelist += "<div><table><thead>";
                packagelist += "<tr><th></th><th width='300px'>{{=T('Package')}}</th><th width='450px'>{{=T('Version')}}</th><th width='100px'>{{=T('Size')}}</th></tr></thead>";
                d = json[section];
                for(var pkg in d) {
                  size = json[section][pkg]['size'];
                  version = json[section][pkg]['version'];
                  packagelist += "<tr>";
                  packagelist += "<td><input type='button' value='+' style='margin:0px 10px 0 0; border:0px' onClick='addpackage(\"" + pkg + "\");'></td>";
                  packagelist += "<td>" + pkg + "</td>";
                  packagelist += "<td>" + version + "</td>";
                  packagelist += "<td>" + size + "</td>";
                  packagelist += "</tr>";
                }
                packagelist += "</table></div>"
              }
             document.getElementById('packagelist').innerHTML = packagelist; 
             $(function() {
               $( "#packagelist" ).accordion({ heightStyle: "content", collapsible: true, active: false });
             });
           },
           error : function(xhr, textStatus, errorThrown ) {
           if (textStatus == 'parsererror') {
             var error = "{{=T('There was a problem parsing the package list, is it really valid json?')}}";
                                document.getElementById('packagelist').innerHTML = error;
             return;
           }        
           if (textStatus == 'timeout') {
             this.tryCount++;
             if (this.tryCount <= this.retryLimit) {
               //try again
               $.ajax(this);
               return;
             }
             var error = "{{=T('Loading the package list timed out.')}}";
             document.getElementById('packagelist').innerHTML = error;
             return;
           }
           if (xhr.status == 500) {
             error = "{{=T('The server returned status 500 and the package list could not be loaded, please try again later.')}}";
                            document.getElementById('packagelist').innerHTML = error;
           }
           else {
             error = "{{=T('There was another problem loading the package list.')}}";
             document.getElementById('packagelist').innerHTML = error;
           }
         }
       });
     } 
     ajax_packagelist();         
    </script>        
  </div>
  <!-- End packages tab -->

  <!-- Start upload tab -->
  <h3 id="tab-upload" title="{{=T('>Upload')}}" class="tab">{{=T('Upload')}}</h3>
  <div>
    <div class="tab-description">
        {{=T('Upload a tar.gz file which will be extracted and included in the image. The files in this archive are placed in the root of your image in the same way they are arranged in the archive.')}}
    </div>

    <input type="file" id="upload" class="upload" name="upload"/>
    {{ if form.errors.upload:}}
      <div id="upload__error" class="error">{{=T('Only tar.gz archives can be uploaded.')}}</div>
    {{pass}}
  </div>
  <!-- End upload tab -->

  <!-- Start submit tab -->
  <h3 title="{{=T('Submit')}}">{{=T('Submit')}}</h3>
  <div>
    <div class="tab-description">
        {{=T('Submit the form and build your images. Note: root password will be "admin".')}}
    </div>
    <input type="submit" value="Submit" class="button" />
  </div>
  <!-- End submit tab -->

  <!-- Hidden fields -->
  <input type="hidden" name="target" value="{{=session.target}}" />
  <input type="hidden" name="url" value="{{=session.url}}" />
  {{if not config.noconf == True:}}
  <input type="hidden" name="community" value="{{=session.community}}" />
  {{pass}}
  <input type="hidden" name="mail" value="{{=session.mail}}" />
  {{if not config.noconf == True:}}
	{{if not session.noconf == False:}}
  <input type="hidden" name="noconf" value="True" />
	{{pass}}
  {{pass}}
  {{ if session.ipv6_config:}}
  <input type="hidden" name="ipv6_config" value="{{=session.ipv6_config}}" />
  {{pass}}
  <input type="hidden" name="status" value="1" />
  <input type="hidden" name="rand" value="{{=rand}}" />
  <input type="hidden" name="_formname" value="step2" />
  </div>
</form>

<script type="text/javascript">
  function themeselect() {
    var e = document.getElementById("imageconf_webif");
    var selected = e.options[e.selectedIndex].value;
    if ( selected == "none" ) {
      document.getElementById("theme_options").innerHTML = '';
      lucipackages = "";
      themepackages= "";
      update_defaultpkgs();
    };
    if ( selected == "luci" ) {
      var newdiv = '{{=field_theme}}'
      document.getElementById("theme_options").innerHTML = newdiv;
      lucipackages = "{{=lucipackages}}";
      themepkgs();
      update_defaultpkgs();
      hideAll();
    };
  }
  themeselect();
  themepkgs();
</script>


<script type="text/javascript">
  function ipv6pkgs() {
    if(document.getElementById("imageconf_ipv6")) {
      if(document.getElementById("imageconf_ipv6").checked) {
        ipv6packages='{{=ipv6_packages}}';
        update_defaultpkgs();
      } else {
        ipv6packages = '';
        update_defaultpkgs();
      }
    }
  };

  ipv6pkgs();
  update_defaultpkgs();
</script>

  <!-- REGISTRATOR client -->
  <script src="http://reg.weimarnetz.de/static/jquery-client.js"></script>
  <script>
  // define function to handle api answer as a callback
  function _ffreg_check_callback(answer) {

    // update the status HTML with the result
    jQuery('#imageconf_nodenumber_status').text(answer.result);
        
    var status_color = "lightgrey";
    status_color = answer.free ? 'lightgreen' : 'lightsalmon';
    $('#imageconf_nodenumber').css('background', status_color);
  }
  </script>

{{block footer}}
{{include 'footer.html'}}
{{end}}
